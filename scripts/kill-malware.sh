#!/bin/bash

# Emergency Malware Removal Script
# USE WITH CAUTION - This will stop suspicious processes

echo "ðŸš¨ EMERGENCY MALWARE REMOVAL"
echo "=============================="
echo ""
echo "âš ï¸  WARNING: This script will stop suspicious processes"
echo "Press Ctrl+C to cancel, or wait 5 seconds to continue..."
sleep 5

# Find and kill processes with 'next' in suspicious locations
echo ""
echo "ðŸ” Finding suspicious 'next' processes..."
SUSPICIOUS_PIDS=$(ps aux | grep -E "/\.local/share/next|/var/lib/docker.*next" | grep -v grep | awk '{print $2}')

if [ -z "$SUSPICIOUS_PIDS" ]; then
    echo "âœ… No suspicious processes found by name"
else
    echo "âš ï¸  Found suspicious PIDs: $SUSPICIOUS_PIDS"
    read -p "Kill these processes? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        for pid in $SUSPICIOUS_PIDS; do
            echo "Killing PID: $pid"
            kill -9 $pid 2>/dev/null
        done
    fi
fi

# Stop all Docker containers
echo ""
echo "ðŸ›‘ Stopping all Docker containers..."
read -p "Stop all containers? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    docker stop $(docker ps -q)
    echo "âœ… All containers stopped"
fi

# Check for high CPU processes
echo ""
echo "ðŸ” Finding high CPU processes (>50%)..."
HIGH_CPU=$(ps aux --sort=-%cpu | awk 'NR>1 && $3>50 {print $2, $3, $11}' | head -10)

if [ -z "$HIGH_CPU" ]; then
    echo "âœ… No high CPU processes found"
else
    echo "âš ï¸  High CPU processes:"
    echo "$HIGH_CPU"
    echo ""
    read -p "Kill processes using >50% CPU? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "$HIGH_CPU" | awk '{print $1}' | xargs -r kill -9 2>/dev/null
    fi
fi

echo ""
echo "âœ… Cleanup complete. Monitor CPU usage:"
echo "   watch -n 1 'top -bn1 | head -20'"

