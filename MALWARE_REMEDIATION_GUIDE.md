# ðŸš¨ MALWARE REMEDIATION GUIDE

## Immediate Actions (Do These First!)

### 1. Check What's Using CPU
```bash
# SSH into your VPS
ssh root@your-vps-ip

# Check top processes
top
# Press 'q' to quit, then run:
ps aux --sort=-%cpu | head -20

# Check Docker containers
docker ps
docker stats
```

### 2. Identify the Malicious Process
```bash
# Find processes with 'next' in suspicious locations
ps aux | grep -E "/\.local/share/next|/var/lib/docker.*next"

# Check what files are open by high CPU processes
lsof -p $(ps aux --sort=-%cpu | awk 'NR==2{print $2}')

# Check network connections
netstat -tulpn | grep ESTABLISHED
```

### 3. Stop the Malware
```bash
# Option 1: Stop all Docker containers
docker stop $(docker ps -q)

# Option 2: Kill specific process (replace PID)
kill -9 <PID>

# Option 3: Use the provided script
chmod +x scripts/kill-malware.sh
./scripts/kill-malware.sh
```

### 4. Remove Malicious Files
```bash
# Find and remove suspicious 'next' files in Docker layers
find /var/lib/docker -name "next" -path "*/.local/share/next" -type f -delete

# Clean Docker system
docker system prune -af
docker volume prune -f
```

## Investigation Steps

### Check Docker Containers
```bash
# List all containers (including stopped)
docker ps -a

# Check container logs
docker logs <container-id>

# Inspect container filesystem
docker exec -it <container-id> /bin/sh
# Then inside container:
ps aux
ls -lah /root/.local/share/
file /root/.local/share/next
```

### Check System Logs
```bash
# Recent system logs
journalctl -xe --since "1 hour ago"

# Docker logs
journalctl -u docker.service --since "1 hour ago"

# Authentication logs (check for unauthorized access)
grep "Failed password" /var/log/auth.log | tail -20
```

### Network Analysis
```bash
# Check what's connecting to the internet
ss -tulpn

# Check for suspicious outbound connections
netstat -anp | grep ESTABLISHED | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -rn
```

## Cleanup and Recovery

### 1. Remove All Docker Images and Rebuild
```bash
# Stop all containers
docker stop $(docker ps -aq)

# Remove all containers
docker rm $(docker ps -aq)

# Remove all images
docker rmi $(docker images -q)

# Remove all volumes
docker volume rm $(docker volume ls -q)

# Clean everything
docker system prune -af --volumes
```

### 2. Rebuild from Clean Source
```bash
# On your local machine, ensure code is clean
git status
git log --oneline -10

# Rebuild Docker images
cd /path/to/docm-cics
docker build -f apps/web/Dockerfile -t docm-web .
docker build -f apps/admin/Dockerfile -t docm-admin .
```

### 3. Secure Your System
```bash
# Run security hardening script
chmod +x scripts/secure-system.sh
./scripts/secure-system.sh

# Change all passwords
passwd root
# Change other user passwords too

# Rotate API keys
# - Supabase service role key
# - Database passwords
# - SMTP credentials
# - Stripe keys
```

## Prevention

### 1. Secure Docker
```bash
# Don't run containers as root
# Use non-root user (already in Dockerfile)

# Limit container resources
docker run --cpus="2.0" --memory="2g" ...

# Use read-only filesystem where possible
docker run --read-only ...
```

### 2. Monitor System
```bash
# Install monitoring
apt install -y htop iotop nethogs

# Set up alerts for high CPU
# Use monitoring tools like Prometheus, Grafana, or Datadog
```

### 3. Regular Security Audits
```bash
# Scan for vulnerabilities
docker scan <image-name>

# Check for rootkits
rkhunter --check

# Update regularly
apt update && apt upgrade -y
```

## What to Check in Your Code

1. **Review package.json files** - Check for suspicious dependencies
2. **Review Dockerfiles** - Ensure no malicious downloads
3. **Check git history** - Look for unauthorized commits
4. **Review environment variables** - Ensure no hardcoded secrets
5. **Check CI/CD pipelines** - Ensure build process is secure

## Emergency Contacts

If you need immediate help:
1. **Isolate the system** - Disconnect from network if possible
2. **Document everything** - Take screenshots, save logs
3. **Contact your hosting provider** - They may have incident response
4. **Consider professional help** - Security incident response team

## Post-Incident Checklist

- [ ] All malicious processes stopped
- [ ] All Docker containers/images removed
- [ ] System logs reviewed
- [ ] All passwords changed
- [ ] All API keys rotated
- [ ] Docker images rebuilt from clean source
- [ ] Security monitoring enabled
- [ ] Firewall configured
- [ ] System updated
- [ ] Codebase audited for backdoors
- [ ] Git history reviewed for unauthorized commits

